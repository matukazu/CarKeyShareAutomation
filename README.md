最終更新：2023/05/23


- [開発環境作成](#開発環境作成)
- [要件：カギ分配問題](#要件カギ分配問題)
  - [概要](#概要)
  - [カギ分配の例](#カギ分配の例)
    - [前提](#前提)
    - [カギを分配する際の条件](#カギを分配する際の条件)
      - [絶対守る条件](#絶対守る条件)
      - [可能な限り絶対守る条件 ※無理な時は無理](#可能な限り絶対守る条件-無理な時は無理)
      - [できれば守る条件](#できれば守る条件)
  - [具体例](#具体例)
    - [良い例](#良い例)
    - [悪い例](#悪い例)
- [設計](#設計)
- [参考：](#参考)

---

# 開発環境作成
仮想環境を作成する
`pipenv install -r ./requirements.txt`

仮想環境に入る
`pipenv shell`

仮想環境内でコマンドを打つ
`pipenv run hoge.py`



# 要件：カギ分配問題
## 概要
「遺伝的アルゴリズム」を勉強したい。
どっかの会社でやっているらしい「社用車を利用する際の人員配置やカギ分配」を題材として
シフト表の自動作成などのような目的関数を最小化する遺伝的アルゴリズムを用いて実装してみる。

## カギ分配の例
### 前提
- 車 2台
  - A： 定員5名
  - B： 定員7名

- カギ 1台に付き2つ
  - カギA-1 ：運転手用
  - カギA-2 ：予備
  - カギB-1 ：運転手用
  - カギB-2 ：予備

- 車利用者
  - 運転可能   3名
  - 運転不可能 7名

また、車利用者は下記の「乗車時間一覧」から乗車時間を1つ希望する

- 乗車時間一覧
  - 予定0：乗らない・乗れない
  - 予定1：18時
  - 予定2：19時
  - 予定3：20時

### カギを分配する際の条件

#### 絶対守る条件
1. 運転手用のカギ(以下、カギ1)は運転可能者が持つ
2. 時間帯ごとに乗車人数が定員オーバーしない
    すなわち、ある時間帯にカギA-1、カギB-2が割り当てられている人がいるとき、
   「車Aの定員 + 車Bの定員 > その時間帯に乗車する人数合計」を満たす

#### 可能な限り絶対守る条件 ※無理な時は無理
1. ある時間帯に乗車することになった人について、希望していた時間帯と同じ

#### できれば守る条件
1. カギは1人2つ以上持たない
2. 同じ時間帯を希望する人が、その時間帯に使う車の予備カギを持つ

## 具体例
### 良い例

| 運転可 | 利用者名 | 希望予定 | 予定0 | 予定1       | 予定2       | 予定3 |
| ------ | -------- | -------- | ----- | ----------- | ----------- | ----- |
| o      | A        | 予定1    |       | o : カギB-1 |             |       |
| o      | B        | 予定1    |       | o           |             |       |
| o      | C        | 予定2    |       |             | o : カギA-1 |       |
|        | D        | 予定1    |       |             |             |       |
|        | E        | 予定1    |       | o : カギB-2 |             |       |
|        | F        | 予定1    |       | o           |             |       |
|        | G        | 予定1    |       | o           |             |       |
|        | H        | 予定1    |       | o           |             |       |
|        | I        | 予定2    |       |             | o : カギA-2 |       |
|        | J        | 予定2    |       |             | o           |       |

予定1：
- 乗車人数：6名
- 利用する車：B (定員：7名)

予定2：
- 乗車人数：3名
- 利用する車：A (定員：5名)

### 悪い例

| 運転可 | 利用者名 | 希望予定 | 予定0 | 予定1       | 予定2            | 予定3 |
| ------ | -------- | -------- | ----- | ----------- | ---------------- | ----- |
| o      | A        | 予定1    |       | o : カギB-1 |                  |       |
| o      | B        | 予定1    |       | o ：カギA-1 |                  |       |
| o      | C        | 予定2    |       |             | ==車がない！！== |       |
|        | D        | 予定1    |       |             |                  |       |
|        | E        | 予定1    |       | o : カギB-2 |                  |       |
|        | F        | 予定1    |       | o           |                  |       |
|        | G        | 予定1    |       | o           |                  |       |
|        | H        | 予定1    |       | o           |                  |       |
|        | I        | 予定1    |       | o : カギA-2 |                  |       |
|        | J        | 予定1    |       | o           |                  |       |

予定1での乗車希望人数が9名なのに対し、
車A,B どちらか1台だけでは収容できない

予定1に車A,B両方使うと、予定2を希望するCさんが使える車がない

# 設計
とりあえずてきとうにメモしておく

モジュール構成
「..>」：関数の呼び出し
「-->」：メインの処理順

```plantUML
@startuml

component ev [
  evaluate
  目的関数(評価関数)の定義関連の処理
]

component indiv [
  individual
  個体1次元配列関連の処理
  ・個体の生成
  ・個体→意味のある表への変換
]


package "main処理"{
  component init [
    init
    処理の初めに走らせる処理
    ・前提条件となる車などのインスタンス作成
    ・個体生成用の初期値が入った辞書作成
  ]

  component calc[
    calc_best_individual
    遺伝的アルゴリズムの本体
    最適な個体を選定する
  ]

  component view [
    view
    取得した最適な個体を人がわかりやすい形として
    コンソールに標準出力する
  ]
}

component class [
  MyClass
  クラス定義
]

class .> init : インスタンス生成
init --> calc
calc --> view :最適な個体1次元配列

indiv .> calc : 個体の生成
class ..> view : 個体データに合致するインスタンス取得

indiv ..> view : 個体の変換
ev ..> calc : 評価関数の提供

@enduml


```

# 参考：
[遺伝的アルゴリズムでナーススケジューリング問題（シフト最適化）を解く - Qiita](https://qiita.com/shouta-dev/items/1970c2746c3c30f6b39e)

[Deapの基本的な使い方で参考になったサイト](https://dse-souken.com/2021/05/25/ai-19/)

[個体データにnumpyを使う参考](https://darden.hatenablog.com/entry/2017/04/18/225459#%E5%80%8B%E4%BD%93%E3%81%ABnumpy%E3%81%AEndarray%E3%82%92%E4%BD%BF%E3%81%86%E5%A0%B4%E5%90%88)

